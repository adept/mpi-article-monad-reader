--- threaded.hs	2011-08-05 20:02:27.000000000 +0100
+++ mpi.hs	2011-08-05 00:04:00.000000000 +0100
@@ -1,10 +1,9 @@
 module Main where
 
 import Control.Parallel.Strategies
+import Control.Parallel.MPI.Simple
 
-u2 = parBuffer 2 rseq
-
-approx f xs ws = sum ( [w * f x | (x,w) <- zip xs ws] )
+approx f xs ws = sum [w * f x | (x,w) <- zip xs ws]
  
 integrateOpen :: Fractional a => a -> [a] -> (a -> a) -> a -> a -> Int -> a
 integrateOpen v vs f a b n = approx f xs ws * h / v where
@@ -12,7 +11,7 @@
   h = (b-a) / fromIntegral m
   ws = concat $ replicate n vs
   c = a + h/2
-  xs = [c + h * fromIntegral i | i <- [0..m-1]] `using` u2
+  xs = [c + h * fromIntegral i | i <- [0..m-1]]
  
 integrateClosed :: Fractional a => a -> [a] -> (a -> a) -> a -> a -> Int -> a
 integrateClosed v vs f a b n = approx f xs ws * h / v where
@@ -48,19 +47,26 @@
 -- Integrate f on [a,b] with n steps using all available methods, print results
 tabulate :: Fractional a => (a->a) -> a -> a -> Int -> [String]
 tabulate f a b n =
-  map (\(name, method) -> name ++ (show $ method f a b n)) methods --`using` parList rdeepseq
+  map (\(name, method) -> name ++ (show $ method f a b n)) methods `using` parList rdeepseq
 
--- Integrate several sample functions
-tabulateSeveral =
-  map (unlines . uncurry4 tabulate)
+-- Integrate one of sample functions
+tabulateSome num =
+  unlines . uncurry4 tabulate $ 
   [ ((\x -> x ^ 3), 0, 1   , 1000000)
   , ((\x -> 1 / x), 1, 100 , 1000000)  
   , ((\x -> x)    , 0, 5000, 5000000)
   , ((\x -> x)    , 0, 6000, 6000000)
-  ] -- `using` parList rdeepseq
-  -- We could parallelize tablulare or tabulateSeveral, but not both at once
+  ] !! num
   where
     uncurry4 f (a,b,c,d) = f a b c d
   
-main = do
-  putStrLn $ unlines $ tabulateSeveral
+main = mpi $ do
+  size <- commSize commWorld
+  rank <- commRank commWorld
+  let root = 0 :: Rank
+  let my_results = tabulateSome (fromRank rank)
+  if rank == root then 
+    do results <- gatherRecv commWorld root my_results
+       putStrLn $ unlines $ results
+    else gatherSend commWorld root my_results
+    
